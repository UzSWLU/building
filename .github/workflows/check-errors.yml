name: ğŸ” Check Building API Errors

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours

jobs:
  check-errors:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 5
    steps:
      - name: ğŸ“Š Check container status
        id: container_status
        run: |
          echo "ğŸ“Š Container Status:"
          docker-compose -f /var/www/building-api/docker-compose.prod.yml ps

      - name: ğŸ” Check API errors (last 500 lines)
        id: api_errors
        run: |
          echo "ğŸ” Checking API errors..."
          echo "error_count<<EOF" >> $GITHUB_OUTPUT
          docker-compose -f /var/www/building-api/docker-compose.prod.yml logs --tail=500 web | \
            grep -i "error\|exception\|failed\|traceback" | wc -l >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo ""
          echo "ğŸ“ Recent Errors:"
          docker-compose -f /var/www/building-api/docker-compose.prod.yml logs --tail=500 web | \
            grep -i "error\|exception\|failed\|traceback" | tail -20 || echo "âœ… No errors found"

      - name: ğŸ” Check PostgreSQL errors
        run: |
          echo ""
          echo "ğŸ” Checking PostgreSQL errors..."
          docker-compose -f /var/www/building-api/docker-compose.prod.yml logs --tail=200 db | \
            grep -i "error\|warning" | tail -10 || echo "âœ… No PostgreSQL errors"

      - name: ğŸ” Check Nginx errors
        run: |
          echo ""
          echo "ğŸ” Checking Nginx errors..."
          docker-compose -f /var/www/building-api/docker-compose.prod.yml logs --tail=200 nginx | \
            grep -i "error" | tail -10 || echo "âœ… No Nginx errors"

      - name: ğŸ¥ Test API endpoints
        run: |
          echo ""
          echo "ğŸ¥ Testing API endpoints..."

          echo "1. Health check:"
          curl -s https://building.swagger.uzswlu.uz/health/ || echo "âŒ Health check failed"

          echo ""
          echo "2. Swagger UI:"
          curl -s https://building.swagger.uzswlu.uz/ | grep -i "swagger\|openapi" || echo "âŒ Swagger UI check failed"

          echo ""
          echo "3. API Schema:"
          curl -s https://building.swagger.uzswlu.uz/api/schema/ | head -100 || echo "âŒ API schema check failed"

          echo ""
          echo "4. Buildings API:"
          curl -s https://building.swagger.uzswlu.uz/api/buildings/ | head -100 || echo "âŒ Buildings API check failed"

      - name: ğŸ“Š Database statistics
        run: |
          echo ""
          echo "ğŸ“Š Database Statistics:"
          docker-compose -f /var/www/building-api/docker-compose.prod.yml exec -T db psql \
            -U building -d building -c "
              SELECT 
                'Buildings' as table_name, COUNT(*) as count FROM app_rttm_building
              UNION ALL
              SELECT 'Rooms', COUNT(*) FROM app_rttm_room
              UNION ALL
              SELECT 'Devices', COUNT(*) FROM app_rttm_device
              UNION ALL
              SELECT 'Repair Requests', COUNT(*) FROM app_rttm_repairrequest
              UNION ALL
              SELECT 'Service Logs', COUNT(*) FROM app_rttm_servicelog;
            " || echo "âš ï¸  Database query failed"

      - name: ğŸ“ˆ System resources
        run: |
          echo ""
          echo "ğŸ“ˆ System Resources:"
          echo "Disk usage:"
          df -h /var/www/building-api

          echo ""
          echo "Docker disk usage:"
          docker system df

      - name: âœ… Summary
        run: |
          echo ""
          echo "âœ… Error check completed!"
          echo "API Errors found: ${{ steps.api_errors.outputs.error_count }}"
