name: 🔍 Check Building API Errors

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours

jobs:
  check-errors:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 5
    steps:
      - name: 📊 Check container status
        id: container_status
        run: |
          echo "📊 Container Status:"
          docker-compose -f /var/www/building-api/docker-compose.prod.yml ps

      - name: 🔍 Check API errors (last 500 lines)
        id: api_errors
        run: |
          echo "🔍 Checking API errors..."
          echo "error_count<<EOF" >> $GITHUB_OUTPUT
          docker-compose -f /var/www/building-api/docker-compose.prod.yml logs --tail=500 web | \
            grep -i "error\|exception\|failed\|traceback" | wc -l >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo ""
          echo "📝 Recent Errors:"
          docker-compose -f /var/www/building-api/docker-compose.prod.yml logs --tail=500 web | \
            grep -i "error\|exception\|failed\|traceback" | tail -20 || echo "✅ No errors found"

      - name: 🔍 Check PostgreSQL errors
        run: |
          echo ""
          echo "🔍 Checking PostgreSQL errors..."
          docker-compose -f /var/www/building-api/docker-compose.prod.yml logs --tail=200 db | \
            grep -i "error\|warning" | tail -10 || echo "✅ No PostgreSQL errors"

      - name: 🔍 Check Nginx errors
        run: |
          echo ""
          echo "🔍 Checking Nginx errors..."
          docker-compose -f /var/www/building-api/docker-compose.prod.yml logs --tail=200 nginx | \
            grep -i "error" | tail -10 || echo "✅ No Nginx errors"

      - name: 🏥 Test API endpoints
        run: |
          echo ""
          echo "🏥 Testing API endpoints..."

          echo "1. Health check:"
          curl -s https://building.swagger.uzswlu.uz/health/ || echo "❌ Health check failed"

          echo ""
          echo "2. Swagger UI:"
          curl -s https://building.swagger.uzswlu.uz/ | grep -i "swagger\|openapi" || echo "❌ Swagger UI check failed"

          echo ""
          echo "3. API Schema:"
          curl -s https://building.swagger.uzswlu.uz/api/schema/ | head -100 || echo "❌ API schema check failed"

          echo ""
          echo "4. Buildings API:"
          curl -s https://building.swagger.uzswlu.uz/api/buildings/ | head -100 || echo "❌ Buildings API check failed"

      - name: 📊 Database statistics
        run: |
          echo ""
          echo "📊 Database Statistics:"
          docker-compose -f /var/www/building-api/docker-compose.prod.yml exec -T db psql \
            -U building -d building -c "
              SELECT 
                'Buildings' as table_name, COUNT(*) as count FROM app_rttm_building
              UNION ALL
              SELECT 'Rooms', COUNT(*) FROM app_rttm_room
              UNION ALL
              SELECT 'Devices', COUNT(*) FROM app_rttm_device
              UNION ALL
              SELECT 'Repair Requests', COUNT(*) FROM app_rttm_repairrequest
              UNION ALL
              SELECT 'Service Logs', COUNT(*) FROM app_rttm_servicelog;
            " || echo "⚠️  Database query failed"

      - name: 📈 System resources
        run: |
          echo ""
          echo "📈 System Resources:"
          echo "Disk usage:"
          df -h /var/www/building-api

          echo ""
          echo "Docker disk usage:"
          docker system df

      - name: ✅ Summary
        run: |
          echo ""
          echo "✅ Error check completed!"
          echo "API Errors found: ${{ steps.api_errors.outputs.error_count }}"
