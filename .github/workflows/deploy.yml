name: ðŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Pull latest code
        run: |
          cd /var/www/building-api
          
          # Fix git ownership issue
          echo "ðŸ”§ Fixing git ownership..."
          git config --global --add safe.directory /var/www/building-api
          
          echo "ðŸ“¥ Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

      - name: ðŸ”§ Update environment variables
        run: |
          cd /var/www/building-api
          
          echo "ðŸ” Checking .env.production..."
          if [ ! -f .env.production ]; then
            echo "ðŸ“ Creating .env.production from template..."
            cp env.prod.example .env.production
          fi
          
          # Create complete environment file
          cat > .env.production << 'EOF'
# Production Environment Variables for Building API

# Django Settings
DJANGO_SECRET_KEY=django-insecure-production-secret-key-change-this-in-production
DJANGO_DEBUG=0
DJANGO_ALLOWED_HOSTS=building.swagger.uzswlu.uz

# Database Settings
POSTGRES_DB=building
POSTGRES_USER=building
POSTGRES_PASSWORD=building_production_password_2024
POSTGRES_HOST=db
POSTGRES_PORT=5432

# Auth Service
AUTH_BASE_URL=https://auth.uzswlu.uz
AUTH_TIMEOUT=10
AUTH_CACHE_TIMEOUT=300

# OAuth URLs
BACKEND_URL=https://auth.uzswlu.uz
FRONTEND_CALLBACK_URL=https://building.swagger.uzswlu.uz/callback,http://localhost:5001/callback

# Server Settings
SERVER_HOST=172.22.0.19
SERVER_USER=root
SERVER_PORT=22
EOF
          
          echo "âœ… Environment configured:"
          cat .env.production

      - name: ðŸ³ Build and deploy
        run: |
          cd /var/www/building-api
          
          echo "ðŸ›‘ Stopping existing containers..."
          docker-compose -f docker-compose.prod.yml down -v
          
          echo "ðŸ”¨ Building new containers..."
          docker-compose -f docker-compose.prod.yml build --no-cache
          
          echo "ðŸš€ Starting services..."
          docker-compose -f docker-compose.prod.yml up -d
          
          echo "â³ Waiting for services to start..."
          sleep 30

      - name: ðŸ—„ï¸ Run database migrations
        run: |
          cd /var/www/building-api
          echo "ðŸ—„ï¸ Running database migrations..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate
          
          echo "ðŸ“Š Creating superuser if not exists..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py shell -c "
          from django.contrib.auth import get_user_model
          User = get_user_model()
          if not User.objects.filter(username='admin').exists():
              User.objects.create_superuser('admin', 'admin@uzswlu.uz', 'admin123')
              print('Superuser created')
          else:
              print('Superuser already exists')
          "

      - name: ðŸ“Š Collect static files
        run: |
          cd /var/www/building-api
          echo "ðŸ“Š Collecting static files..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput

      - name: ðŸ¥ Health check
        run: |
          cd /var/www/building-api
          echo "ðŸ¥ Performing health checks..."
          
          # Wait for services to be ready
          sleep 10
          
          # Check container status
          echo "ðŸ“Š Container Status:"
          docker-compose -f docker-compose.prod.yml ps
          
          # Test API endpoints
          echo "ðŸ” Testing API endpoints..."
          
          # Health check (local)
          curl -f http://localhost:5001/health/ || echo "âš ï¸ Health check failed"
          
          # Swagger UI (local)
          curl -f http://localhost:5001/ || echo "âš ï¸ Swagger UI check failed"
          
          # API schema (local)
          curl -f http://localhost:5001/api/schema/ || echo "âš ï¸ API schema check failed"

      - name: ðŸ“ Display logs
        if: always()
        run: |
          cd /var/www/building-api
          echo "ðŸ“ Recent application logs:"
          docker-compose -f docker-compose.prod.yml logs --tail=50 web

      - name: âœ… Deployment success
        run: |
          echo "âœ… =============================================="
          echo "âœ… BUILDING API DEPLOYED SUCCESSFULLY!"
          echo "âœ… =============================================="
          echo ""
          echo "ðŸ”— API: https://building.swagger.uzswlu.uz/"
          echo "ðŸ”— Swagger UI: https://building.swagger.uzswlu.uz/"
          echo "ðŸ”— Health Check: https://building.swagger.uzswlu.uz/health/"
          echo "ðŸ”— Admin: https://building.swagger.uzswlu.uz/admin/"
          echo ""
          echo "ðŸ“Š Container Status:"
          docker-compose -f docker-compose.prod.yml ps