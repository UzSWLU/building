name: Deploy Building API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "ğŸš€ Starting Building API deployment..."
        echo "ğŸ“ Working directory: $(pwd)"
        echo "ğŸ“… Deployment time: $(date)"
        
    - name: Stop existing containers
      run: |
        echo "ğŸ›‘ Stopping existing containers..."
        docker-compose -f docker-compose.prod.yml down || echo "No containers to stop"
        
    - name: Build and start containers
      run: |
        echo "ğŸ”¨ Building and starting containers..."
        docker-compose -f docker-compose.prod.yml up -d --build
        
    - name: Wait for services
      run: |
        echo "â³ Waiting for services to start..."
        sleep 30
        
    - name: Run database migrations
      run: |
        echo "ğŸ—„ï¸ Running database migrations..."
        docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate
        
    - name: Create superuser
      run: |
        echo "ğŸ‘¤ Creating superuser..."
        docker-compose -f docker-compose.prod.yml exec -T web python manage.py shell -c "
        from django.contrib.auth import get_user_model
        User = get_user_model()
        if not User.objects.filter(username='admin').exists():
            User.objects.create_superuser('admin', 'admin@uzswlu.uz', 'admin123')
            print('Superuser created: admin/admin123')
        else:
            print('Superuser already exists')
        "
        
    - name: Collect static files
      run: |
        echo "ğŸ“Š Collecting static files..."
        docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput
        
    - name: Health check
      run: |
        echo "ğŸ¥ Performing health checks..."
        sleep 10
        
        # Check container status
        echo "ğŸ“Š Container Status:"
        docker-compose -f docker-compose.prod.yml ps
        
        # Test API endpoints
        echo "ğŸ” Testing API endpoints..."
        
        # Health check
        if curl -f -s http://localhost:5001/api/health/ > /dev/null; then
            echo "âœ… Health check passed"
        else
            echo "âŒ Health check failed"
        fi
        
        # API schema
        if curl -f -s http://localhost:5001/api/schema/ > /dev/null; then
            echo "âœ… API schema accessible"
        else
            echo "âŒ API schema not accessible"
        fi
        
    - name: Cleanup
      run: |
        echo "ğŸ§¹ Cleaning up old Docker images..."
        docker image prune -f
        
    - name: Deployment success
      run: |
        echo ""
        echo "âœ… =============================================="
        echo "âœ… BUILDING API DEPLOYED SUCCESSFULLY!"
        echo "âœ… =============================================="
        echo ""
        echo "ğŸ”— API: https://building.swagger.uzswlu.uz/"
        echo "ğŸ”— Swagger UI: https://building.swagger.uzswlu.uz/"
        echo "ğŸ”— Health Check: https://building.swagger.uzswlu.uz/api/health/"
        echo "ğŸ”— Admin: https://building.swagger.uzswlu.uz/admin/"
        echo ""
        echo "ğŸ‘¤ Default Admin Credentials:"
        echo "   Username: admin"
        echo "   Password: admin123"
        echo ""
        echo "ğŸ“Š Container Status:"
        docker-compose -f docker-compose.prod.yml ps