name: Build Building API

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "docs/**"
  workflow_dispatch: # Manual trigger for testing

jobs:
  validate:
    name: 🔍 Validate YAML
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔍 Validate workflow files
        run: |
          echo "🔍 Validating YAML syntax..."
          echo "📝 Checking workflow file exists..."
          if [ -f ".github/workflows/deploy.yml" ]; then
            echo "✅ deploy.yml exists"
          else
            echo "❌ deploy.yml not found"
            exit 1
          fi
          echo "✅ Basic validation completed!"

  build:
    name: 🔨 Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔨 Build Docker Image
        run: |
          echo "🔨 Building Docker image..."
          docker build -f Dockerfile.prod -t building-api:latest .

      - name: 🧪 Test Docker Image
        run: |
          echo "🧪 Testing Docker image..."
          docker run --rm building-api:latest python manage.py check

      - name: ✅ Build Success
        run: |
          echo "✅ =============================================="
          echo "✅ BUILDING API BUILD COMPLETED!"
          echo "✅ =============================================="
          echo ""
          echo "🔗 Docker image: building-api:latest"
          echo "🔗 Ready for manual deployment"
          echo ""
          echo "📋 Manual deployment steps:"
          echo "1. SSH to server: ssh root@172.22.0.19"
          echo "2. Go to directory: cd /var/www/building-api"
          echo "3. Pull latest code: git pull origin main"
          echo "4. Deploy: docker-compose -f docker-compose.prod.yml down -v"
          echo "5. Deploy: docker-compose -f docker-compose.prod.yml up -d --build"
          echo ""
          echo "🌐 Domain: https://building.api.uzswlu.uz"
          echo "👤 Admin: admin / admin123"
