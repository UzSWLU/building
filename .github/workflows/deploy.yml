name: Build Building API

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "docs/**"
  workflow_dispatch: # Manual trigger for testing

jobs:
  validate:
    name: ğŸ” Validate YAML
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Validate workflow files
        run: |
          echo "ğŸ” Validating YAML syntax..."
          echo "ğŸ“ Checking workflow file exists..."
          if [ -f ".github/workflows/deploy.yml" ]; then
            echo "âœ… deploy.yml exists"
          else
            echo "âŒ deploy.yml not found"
            exit 1
          fi
          echo "âœ… Basic validation completed!"

  build:
    name: ğŸ”¨ Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”¨ Build Docker Image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -f Dockerfile.prod -t building-api:latest .

      - name: ğŸ§ª Test Docker Image
        run: |
          echo "ğŸ§ª Testing Docker image..."
          docker run --rm building-api:latest python manage.py check

      - name: âœ… Build Success
        run: |
          echo "âœ… =============================================="
          echo "âœ… BUILDING API BUILD COMPLETED!"
          echo "âœ… =============================================="
          echo ""
          echo "ğŸ”— Docker image: building-api:latest"
          echo "ğŸ”— Ready for manual deployment"
          echo ""
          echo "ğŸ“‹ Manual deployment steps:"
          echo "1. SSH to server: ssh root@172.22.0.19"
          echo "2. Go to directory: cd /var/www/building-api"
          echo "3. Pull latest code: git pull origin main"
          echo "4. Deploy: docker-compose -f docker-compose.prod.yml down -v"
          echo "5. Deploy: docker-compose -f docker-compose.prod.yml up -d --build"
          echo ""
          echo "ğŸŒ Domain: https://building.api.uzswlu.uz"
          echo "ğŸ‘¤ Admin: admin / admin123"
